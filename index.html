<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multilogin Auto-Tagger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@livechat/agent-app-sdk@1.6.3/dist/agentapp.umd.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
  </style>
</head>
<body>
  <script>
    (async () => {
      try {
        const widget = await LiveChat.createDetailsWidget();

        // Render the native section with a button
        async function render(statusText = "Ready") {
          await widget.modifySection({
            sections: [
              {
                title: "Auto Tags",
                components: [
                  { type: "button", id: "addTagsBtn", label: "Add tags" },
                  { type: "text", text: statusText }
                ]
              }
            ]
          });
        }
        await render();

        // Handle button click
        widget.on("customer_details_section_button_click", async ({ buttonId }) => {
          if (buttonId !== "addTagsBtn") return;
          try {
            await render("Processing…");
            const profile = await widget.getCustomerProfile();
            const chatId = profile?.chat?.chat_id;
            const threadId = profile?.chat?.id;
            const plan = profile?.customVariables?.Plan ?? "(no plan)";

            if (!chatId || !threadId) {
              await render("❌ No chat_id / thread_id");
              return;
            }

            // For now just display IDs, later we will call n8n webhook
            await render(`✅ Chat: ${chatId}, Thread: ${threadId}, Plan: ${plan}`);
          } catch (e) {
            await render("❌ Error in widget");
          }
        });
      } catch (e) {
        // Fail silently if SDK init fails
      }
    })();
  </script>
</body>
</html>
