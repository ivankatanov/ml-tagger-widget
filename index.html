<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multilogin Auto-Tagger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@livechat/agent-app-sdk@1.6.3/dist/agentapp.umd.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7fb; }
    .card { max-width: 560px; margin: 24px; padding: 16px 18px; background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; margin-top:12px; }
    #status { margin-top:12px; }
    .ok { color:#127e00 } .err { color:#b00020 }
  </style>
</head>
<body>
  <div class="card">
    <h3>Multilogin Auto-Tagger</h3>
    <button id="addTagsBtn">➕ Add auto_tagging_test</button>
    <div id="status">Widget loaded ✅</div>
  </div>

  <script>
    (async () => {
      let widget;
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('addTagsBtn');

      function setStatus(text, cls="") {
        statusEl.className = cls;
        statusEl.textContent = text;
      }

      try {
        widget = await LiveChat.createDetailsWidget();
        setStatus("SDK initialized ✓", "ok");
      } catch {
        setStatus("❌ SDK init failed", "err");
        return;
      }

      btn.addEventListener("click", async () => {
        try {
          setStatus("Sending request…");
          const profile = await widget.getCustomerProfile();
          const chatId = profile?.chat?.chat_id;
          const threadId = profile?.chat?.id;

          if (!chatId || !threadId) {
            setStatus("❌ No chatId/threadId", "err");
            return;
          }

          const resp = await fetch("https://npm.mlx.yt/webhook/livechat/add-tags", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: chatId,
              thread_id: threadId,
              tag: "auto_tagging_test"
            })
          });

          setStatus(resp.ok ? "✅ Tag sent to n8n" : "❌ Error " + resp.status, resp.ok ? "ok" : "err");
        } catch (e) {
          setStatus("❌ Request failed", "err");
          console.error(e);
        }
      });
    })();
  </script>
</body>
</html>
