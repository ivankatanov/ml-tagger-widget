<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multilogin Auto-Tagger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@livechat/agent-app-sdk@1.6.3/dist/agentapp.umd.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7fb; }
    .card { max-width: 560px; margin: 24px; padding: 16px 18px; background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; margin-top:8px; }
    #status { margin-top:12px; }
    pre { background:#f0f3f9; padding:10px; border-radius:8px; overflow:auto; margin-top:12px; }
    .ok { color:#127e00 } .err { color:#b00020 }
  </style>
</head>
<body>
  <div class="card">
    <h3>Multilogin Auto-Tagger</h3>
    <button id="addTagBtn">‚ûï Get Tags</button>
    <button id="infoBtn">üë§ Get user info</button>
    <div id="status">Widget loaded ‚úÖ</div>
    <pre id="log" style="display:none;"></pre>
  </div>

  <script>
    (async () => {
      let widget;
      const statusEl = document.getElementById('status');
      const logEl = document.getElementById('log');
      const btnAdd = document.getElementById('addTagBtn');
      const btnInfo = document.getElementById('infoBtn');

      function setStatus(text, cls="") {
        statusEl.className = cls;
        statusEl.textContent = text;
      }
      function log(data) {
        logEl.style.display = 'block';
        logEl.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      }

      try {
        widget = await LiveChat.createDetailsWidget();
        setStatus("SDK initialized ‚úì", "ok");
      } catch {
        setStatus("‚ùå SDK init failed", "err");
        return;
      }

      // === Add AutoTaggingTest (—Å profile) ===
      btnAdd.addEventListener("click", async () => {
        try {
          setStatus("Sending request‚Ä¶");
          const profile = await widget.getCustomerProfile();
          const chatId = profile?.chat?.chat_id;
          const threadId = profile?.chat?.id;

          if (!chatId || !threadId) {
            setStatus("‚ùå No chatId/threadId", "err");
            return;
          }

          const resp = await fetch("https://npm.mlx.yt/webhook/livechat/add-tags", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: chatId,
              thread_id: threadId,
              tag: "AutoTaggingTest",
              profile // <== —Ç—É—Ç —É—Ö–æ–¥–∏—Ç –≤—Å—ë
            })
          });

          setStatus(resp.ok ? "‚úÖ Tag + profile sent" : "‚ùå Error " + resp.status, resp.ok ? "ok" : "err");
        } catch (e) {
          setStatus("‚ùå Request failed", "err");
          console.error(e);
        }
      });

      // === Get user info (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) ===
      btnInfo.addEventListener("click", async () => {
        try {
          setStatus("Fetching user info‚Ä¶");
          const profile = await widget.getCustomerProfile();
          setStatus("‚úÖ User info loaded", "ok");
          log(profile);
        } catch (e) {
          setStatus("‚ùå Failed to get user info", "err");
          log(e?.message || String(e));
        }
      });
    })();
  </script>
</body>
</html>
