<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multilogin Auto-Tagger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@livechat/agent-app-sdk@1.6.3/dist/agentapp.umd.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 20px; }
    .fallback { color: #555; }
  </style>
</head>
<body>
  <!-- Fallback content for direct access -->
  <div class="fallback">
    <h2>Multilogin Auto-Tagger</h2>
    <p>Widget placeholder is working ✅</p>
  </div>

  <script>
    (async () => {
      try {
        const widget = await LiveChat.createDetailsWidget();

        // Remove fallback once SDK is ready
        document.querySelector(".fallback")?.remove();

        async function render(statusText = "Ready") {
          await widget.modifySection({
            sections: [
              {
                title: "Auto Tags",
                components: [
                  { type: "button", id: "addTagsBtn", label: "Add tags" },
                  { type: "text", text: statusText }
                ]
              }
            ]
          });
        }
        await render();

        widget.on("customer_details_section_button_click", async ({ buttonId }) => {
          if (buttonId !== "addTagsBtn") return;
          try {
            await render("Processing…");
            const profile = await widget.getCustomerProfile();
            const chatId = profile?.chat?.chat_id;
            const threadId = profile?.chat?.id;
            const plan = profile?.customVariables?.Plan ?? "(no plan)";

            if (!chatId || !threadId) {
              await render("❌ No chat_id / thread_id");
              return;
            }

            await render(`✅ Chat: ${chatId}, Thread: ${threadId}, Plan: ${plan}`);
          } catch (e) {
            await render("❌ Error in widget");
          }
        });
      } catch (e) {
        console.error("Widget init failed", e);
      }
    })();
  </script>
</body>
</html>
